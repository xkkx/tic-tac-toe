(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))s(r);new MutationObserver(r=>{for(const o of r)if(o.type==="childList")for(const a of o.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&s(a)}).observe(document,{childList:!0,subtree:!0});function n(r){const o={};return r.integrity&&(o.integrity=r.integrity),r.referrerPolicy&&(o.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?o.credentials="include":r.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function s(r){if(r.ep)return;r.ep=!0;const o=n(r);fetch(r.href,o)}})();function G(t){var e=0,n=t.children,s=n&&n.length;if(!s)e=1;else for(;--s>=0;)e+=n[s].value;t.value=e}function F(){return this.eachAfter(G)}function Z(t,e){let n=-1;for(const s of this)t.call(e,s,++n,this);return this}function K(t,e){for(var n=this,s=[n],r,o,a=-1;n=s.pop();)if(t.call(e,n,++a,this),r=n.children)for(o=r.length-1;o>=0;--o)s.push(r[o]);return this}function J(t,e){for(var n=this,s=[n],r=[],o,a,c,h=-1;n=s.pop();)if(r.push(n),o=n.children)for(a=0,c=o.length;a<c;++a)s.push(o[a]);for(;n=r.pop();)t.call(e,n,++h,this);return this}function Q(t,e){let n=-1;for(const s of this)if(t.call(e,s,++n,this))return s}function tt(t){return this.eachAfter(function(e){for(var n=+t(e.data)||0,s=e.children,r=s&&s.length;--r>=0;)n+=s[r].value;e.value=n})}function et(t){return this.eachBefore(function(e){e.children&&e.children.sort(t)})}function nt(t){for(var e=this,n=rt(e,t),s=[e];e!==n;)e=e.parent,s.push(e);for(var r=s.length;t!==n;)s.splice(r,0,t),t=t.parent;return s}function rt(t,e){if(t===e)return t;var n=t.ancestors(),s=e.ancestors(),r=null;for(t=n.pop(),e=s.pop();t===e;)r=t,t=n.pop(),e=s.pop();return r}function it(){for(var t=this,e=[t];t=t.parent;)e.push(t);return e}function st(){return Array.from(this)}function ot(){var t=[];return this.eachBefore(function(e){e.children||t.push(e)}),t}function at(){var t=this,e=[];return t.each(function(n){n!==t&&e.push({source:n.parent,target:n})}),e}function*ct(){var t=this,e,n=[t],s,r,o;do for(e=n.reverse(),n=[];t=e.pop();)if(yield t,s=t.children)for(r=0,o=s.length;r<o;++r)n.push(s[r]);while(n.length)}function N(t,e){t instanceof Map?(t=[void 0,t],e===void 0&&(e=ut)):e===void 0&&(e=lt);for(var n=new O(t),s,r=[n],o,a,c,h;s=r.pop();)if((a=e(s.data))&&(h=(a=Array.from(a)).length))for(s.children=a,c=h-1;c>=0;--c)r.push(o=a[c]=new O(a[c])),o.parent=s,o.depth=s.depth+1;return n.eachBefore(ft)}function ht(){return N(this).eachBefore(dt)}function lt(t){return t.children}function ut(t){return Array.isArray(t)?t[1]:null}function dt(t){t.data.value!==void 0&&(t.value=t.data.value),t.data=t.data.data}function ft(t){var e=0;do t.height=e;while((t=t.parent)&&t.height<++e)}function O(t){this.data=t,this.depth=this.height=0,this.parent=null}O.prototype=N.prototype={constructor:O,count:F,each:Z,eachAfter:J,eachBefore:K,find:Q,sum:tt,sort:et,path:nt,ancestors:it,descendants:st,leaves:ot,links:at,copy:ht,[Symbol.iterator]:ct};function pt(t,e){return t.parent===e.parent?1:2}function D(t){var e=t.children;return e?e[0]:t.t}function I(t){var e=t.children;return e?e[e.length-1]:t.t}function mt(t,e,n){var s=n/(e.i-t.i);e.c-=s,e.s+=n,t.c+=s,e.z+=n,e.m+=n}function gt(t){for(var e=0,n=0,s=t.children,r=s.length,o;--r>=0;)o=s[r],o.z+=e,o.m+=e,e+=o.s+(n+=o.c)}function yt(t,e,n){return t.a.parent===e.parent?t.a:n}function _(t,e){this._=t,this.parent=null,this.children=null,this.A=null,this.a=this,this.z=0,this.m=0,this.c=0,this.s=0,this.t=null,this.i=e}_.prototype=Object.create(O.prototype);function wt(t){for(var e=new _(t,0),n,s=[e],r,o,a,c;n=s.pop();)if(o=n._.children)for(n.children=new Array(c=o.length),a=c-1;a>=0;--a)s.push(r=n.children[a]=new _(o[a],a)),r.parent=n;return(e.parent=new _(null,0)).children=[e],e}function vt(){var t=pt,e=1,n=1,s=null;function r(i){var l=wt(i);if(l.eachAfter(o),l.parent.m=-l.z,l.eachBefore(a),s)i.eachBefore(h);else{var g=i,d=i,u=i;i.eachBefore(function(m){m.x<g.x&&(g=m),m.x>d.x&&(d=m),m.depth>u.depth&&(u=m)});var f=g===d?1:t(g,d)/2,y=f-g.x,x=e/(d.x+f+y),v=n/(u.depth||1);i.eachBefore(function(m){m.x=(m.x+y)*x,m.y=m.depth*v})}return i}function o(i){var l=i.children,g=i.parent.children,d=i.i?g[i.i-1]:null;if(l){gt(i);var u=(l[0].z+l[l.length-1].z)/2;d?(i.z=d.z+t(i._,d._),i.m=i.z-u):i.z=u}else d&&(i.z=d.z+t(i._,d._));i.parent.A=c(i,d,i.parent.A||g[0])}function a(i){i._.x=i.z+i.parent.m,i.m+=i.parent.m}function c(i,l,g){if(l){for(var d=i,u=i,f=l,y=d.parent.children[0],x=d.m,v=u.m,m=f.m,E=y.m,k;f=I(f),d=D(d),f&&d;)y=D(y),u=I(u),u.a=i,k=f.z+m-d.z-x+t(f._,d._),k>0&&(mt(yt(f,i,g),i,k),x+=k,v+=k),m+=f.m,x+=d.m,E+=y.m,v+=u.m;f&&!I(u)&&(u.t=f,u.m+=m-v),d&&!D(y)&&(y.t=d,y.m+=x-E,g=i)}return g}function h(i){i.x*=e,i.y=i.depth*n}return r.separation=function(i){return arguments.length?(t=i,r):t},r.size=function(i){return arguments.length?(s=!1,e=+i[0],n=+i[1],r):s?null:[e,n]},r.nodeSize=function(i){return arguments.length?(s=!0,e=+i[0],n=+i[1],r):s?[e,n]:null},r}function b(t,e,n){this.k=t,this.x=e,this.y=n}b.prototype={constructor:b,scale:function(t){return t===1?this:new b(this.k*t,this.x,this.y)},translate:function(t,e){return t===0&e===0?this:new b(this.k,this.x+this.k*t,this.y+this.k*e)},apply:function(t){return[t[0]*this.k+this.x,t[1]*this.k+this.y]},applyX:function(t){return t*this.k+this.x},applyY:function(t){return t*this.k+this.y},invert:function(t){return[(t[0]-this.x)/this.k,(t[1]-this.y)/this.k]},invertX:function(t){return(t-this.x)/this.k},invertY:function(t){return(t-this.y)/this.k},rescaleX:function(t){return t.copy().domain(t.range().map(this.invertX,this).map(t.invert,t))},rescaleY:function(t){return t.copy().domain(t.range().map(this.invertY,this).map(t.invert,t))},toString:function(){return"translate("+this.x+","+this.y+") scale("+this.k+")"}};b.prototype;let A;const xt=new Uint8Array(16);function Et(){if(!A&&(A=typeof crypto<"u"&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!A))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return A(xt)}const w=[];for(let t=0;t<256;++t)w.push((t+256).toString(16).slice(1));function Ct(t,e=0){return(w[t[e+0]]+w[t[e+1]]+w[t[e+2]]+w[t[e+3]]+"-"+w[t[e+4]]+w[t[e+5]]+"-"+w[t[e+6]]+w[t[e+7]]+"-"+w[t[e+8]]+w[t[e+9]]+"-"+w[t[e+10]]+w[t[e+11]]+w[t[e+12]]+w[t[e+13]]+w[t[e+14]]+w[t[e+15]]).toLowerCase()}const kt=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto),U={randomUUID:kt};function $t(t,e,n){if(U.randomUUID&&!e&&!t)return U.randomUUID();t=t||{};const s=t.random||(t.rng||Et)();if(s[6]=s[6]&15|64,s[8]=s[8]&63|128,e){n=n||0;for(let r=0;r<16;++r)e[n+r]=s[r];return e}return Ct(s)}class $ extends Error{constructor(e){super(e),this.name="BranchError"}}class L extends Error{constructor(e){super(e),this.name="TransformationError"}}class bt{constructor(e,n){this.states=new Map,this.cache=new Map,this.transformations=e,this.cache.set("initial",n())}getStates(){return this.states}getCache(){return this.cache}async branch(e,n,...s){if(e!=="initial"&&!this.states.has(e))return{apply:function(){throw new $(`State '${e}' does not exist`)},ok:function(i){return this},transformationError:function(i){return this},branchError:function(i){return i(`State '${e}' does not exist`),this}};const r=structuredClone(this.states),o=structuredClone(this.cache),a=$t();r.set(a,{type:n,args:s,parent:e,children:[]}),e!=="initial"&&r.get(e).children.push(a);const c=await R(this.transformations,a,r,o);if(c.length>0)return{apply:function(){throw new $(`Branching from '${e}' resulted in following errors: ${c.map(i=>`'${i.message}' at '${i.id}'`)}`)},ok:function(i){return this},transformationError(i){return i(a,r,o,c),this},branchError(i){return this}};const h=()=>{this.states=r,this.cache=o};return{apply:function(){return h(),a},ok:function(i){return i(a,r,o,h),this},transformationError(i){return this},branchError(i){return this}}}async edit(e,n,...s){if(!this.states.has(e))return{apply:function(){throw new $(`State '${e}' does not exist`)},ok:function(i){return this},transformationError:function(i){return this},branchError:function(i){return i(`State '${e}' does not exist`),this}};const r=structuredClone(this.states),o=structuredClone(this.cache),a=r.get(e);a.type=n,a.args=s;const c=await R(this.transformations,e,r,o);if(c.length>0)return{apply:function(){throw new $(`Editing '${e}' resulted in following errors: ${c.map(i=>`'${i.message}' at '${i.id}'`)}`)},ok:function(i){return this},transformationError(i){return i(r,o,c),this},branchError(i){return this}};const h=()=>{this.states=r,this.cache=o};return{apply:function(){h()},ok:function(i){return i(r,o,h),this},transformationError(i){return this},branchError(i){return this}}}remove(e){if(!this.states.has(e))return{apply:function(){throw new $(`State '${e}' does not exist`)},ok:function(c){return this}};const n=structuredClone(this.states),s=structuredClone(this.cache),r=n.get(e);if(r.parent!=="initial"){const c=n.get(r.parent),h=c.children.indexOf(e);c.children.splice(h,1)}const o=[e];for(const c of o){const h=n.get(c);o.push(...h.children),n.delete(c),s.delete(c)}const a=()=>{this.states=n,this.cache=s};return{apply:function(){a()},ok:function(c){return c(n,s,a),this}}}}function Bt(t,e){const n=new Map([["initial",{id:"initial",data:e.get("initial"),parent:null,children:[]}]]),s=[...t.entries()].filter(([r,o])=>o.parent==="initial").map(([r,o])=>r);for(const r of s){const o=t.get(r);s.push(...o.children);const a=n.get(o.parent),c={id:r,data:e.get(r),parent:a,children:[]};n.set(r,c),a.children.push(c)}return n.get("initial")}async function R(t,e,n,s){const r=[],o=e==="initial"?[...n.entries()].filter(([a,c])=>c.parent==="initial").map(([a,c])=>a):[e];for(const a of o){const c=n.get(a);o.push(...c.children);const h=structuredClone(s.get(c.parent));try{const i=await t[c.type](h,...c.args);s.set(a,i)}catch(i){if(i instanceof L)r.push({id:a,message:i.message});else throw i}}return r}var p=(t=>(t.Empty=" ",t.X="X",t.O="O",t))(p||{});const Ot={move:(t,e,n)=>{if(t.moveCharacter===n)throw new L(`${n} doing 2 moves in a row`);if(t.board[e]!==" ")throw new L(`Index ${e} is already occupied`);return t.board[e]=n,t.moveIndex=e,t.moveCharacter=n,t}};function C(t,e={}){return j(document.createElement(t),e)}function S(t,e={}){return j(document.createElementNS("http://www.w3.org/2000/svg",t),e)}function j(t,{classes:e,content:n,parent:s,style:r,attributes:o}={}){if(e!==void 0&&e.forEach(a=>t.classList.add(a)),n!==void 0&&(typeof n=="string"?t.textContent=n:Array.isArray(n)?n.filter(a=>a!==null).forEach(a=>t.appendChild(a)):n!==null&&t.appendChild(n)),s!==void 0&&s.appendChild(t),r!==void 0&&Object.assign(t.style,r),o!==void 0)for(const a in o)t.setAttribute(a,o[a]);return t}function P(t,e,n,s){const r=t+Math.abs(n-t)*.4,o=n-Math.abs(n-t)*.4;return`M ${t} ${e} C ${r} ${e} ${o} ${s} ${n} ${s}`}var B=(t=>(t.Branch="",t.Cross="✕",t.Pencil="✎",t.Plus="+",t.Restart="🔄",t))(B||{});const q=3,V=.2,At=100,z=250,W="0.5, 0, 0.5, 1",Y=document.getElementById("moveText"),H=document.getElementById("currentPlayer");class _t{constructor(e,n,s){this.boards=new Map,this.links=new Map,this.dragging=!1,this.x=0,this.y=0,this.k=1,this.timeline=n,this.onUpdate=s,this.container=C("div",{parent:e,classes:["tic-tac-toe-container"]}),this.boardContainer=C("div",{parent:this.container,classes:["board-container"]}),this.linkContainer=S("svg",{parent:this.boardContainer,classes:["link-container"]});const r=(o,a,c)=>{requestAnimationFrame(()=>{if(this.k+c>q){const h=q-this.k;o=o/c*h,a=a/c*h,c=h}else if(this.k+c<V){const h=V-this.k;o=o/c*h,a=a/c*h,c=h}this.boardContainer.style.transform=`translate(${this.x+=o}px, ${this.y+=a}px) scale(${this.k+=c})`})};this.container.onpointerdown=()=>{this.dragging=!0},this.container.onpointermove=o=>{this.dragging&&r(o.movementX,o.movementY,0)},this.container.onpointerup=()=>this.dragging=!1,this.container.onpointerleave=()=>this.dragging=!1,this.container.onwheel=o=>{o.preventDefault();let a=-o.deltaY/At;o.ctrlKey||(a=a/10);const c=this.container.getBoundingClientRect(),h=[(o.x-c.left-this.x)/this.k,(o.y-c.top-this.y)/this.k];r(-h[0]*a,-h[1]*a,a)},this.update(p.X)}setSize(e,n){this.container.style.width=`${e}px`,this.container.style.height=`${n}px`,this.resetTranslation()}update(e){Y.textContent="Current move: ",H.textContent=e;const n=Bt(this.timeline.getStates(),this.timeline.getCache()),s=vt().nodeSize([200,200])(N(n));s.descendants().forEach(r=>{const o=r.data.id,a=r.data.data,c=e===p.O&&a.moveCharacter===p.Empty?0:e!==a.moveCharacter?1:2,[h,i,l]=this.getBoardOrDefault(o),g=e===p.X?p.O:p.X;c===1?i.textContent=r.children===void 0?`${B.Plus}  New move`:`${B.Branch}  Branch`:c===2?i.textContent=`${B.Pencil}  Edit`:i.textContent=`${B.Cross}  Impossible`,h.style.transform===""&&r.parent!==null&&(h.style.transform=`translate(${r.parent.y}px, ${r.parent.x}px)`);let d=!0;h.animate([{transform:`translate(${r.y}px, ${r.x}px)`}],{duration:z,easing:`cubic-bezier(${W})`,fill:"forwards"}).onfinish=()=>{h.style.transform=`translate(${r.y}px, ${r.x}px)`,d=!1},l.forEach((u,f)=>{u.textContent=a.board[f],u.classList.remove(...u.classList),u.classList.add("cell"),f===a.moveIndex&&a.moveCharacter!==p.Empty?u.classList.add("cell-last-move"):u.classList.remove("cell-last-move");let y=0,x=!1;u.onmousemove=()=>{this.dragging&&(x=!0)},u.onpointerenter=()=>{if(a.board[f]===p.Empty&&c!==0)u.textContent=e,u.classList.add("cell-valid-move");else{u.classList.add("cell-invalid-move");return}if(c===1)y=1;else{this.forEachDescendant(r.data,m=>{this.getBoardOrDefault(m.id)[2][a.moveIndex].classList.add("cell-removed-move")});let v=!0;this.forEachDescendant(r.data,m=>{m.data.board[f]!==p.Empty&&(v=!1)}),this.forEachDescendant(r.data,m=>{const E=this.getBoardOrDefault(m.id)[2][f];E.classList.add(v?"cell-valid-move":"cell-invalid-move"),E.textContent=m.data.board[f]===p.Empty?e:"?"}),v&&(y=2)}},u.onpointerleave=()=>{if(a.board[f]===p.Empty&&c!==0)u.textContent=a.board[f],u.classList.remove("cell-valid-move");else{u.classList.remove("cell-invalid-move");return}c===2&&(this.forEachDescendant(r.data,v=>{this.getBoardOrDefault(v.id)[2][a.moveIndex].classList.remove("cell-removed-move")}),this.forEachDescendant(r.data,v=>{const m=this.getBoardOrDefault(v.id)[2][f];m.classList.remove("cell-valid-move"),m.classList.remove("cell-invalid-move"),m.textContent=v.data.board[f]}))},u.onclick=async()=>{if(!d){if(x){x=!1;return}y===1?(await this.timeline.branch(o,"move",f,e)).apply():y===2&&(await this.timeline.edit(o,"move",f,e)).apply(),y!==0&&(this.update(g),this.onUpdate(g)),u.onpointerenter!==null&&u.onpointerenter(null),y=0}}})}),s.links().forEach(r=>{const o=this.getLinkOrDefault(r.source.data.id,r.target.data.id),a=this.getBoardOrDefault(r.source.data.id)[0].getBoundingClientRect(),c=this.getBoardOrDefault(r.target.data.id)[0].getBoundingClientRect(),h=r.source.y+a.width/this.k,i=r.source.x+a.height/(2*this.k),l=r.target.y,g=r.target.x+c.height/(2*this.k),d=o.getAttribute("d")??P(h,i,h,i),u=P(h,i,l,g),f=S("animate",{parent:o,attributes:{attributeName:"d",dur:`${z}ms`,from:d,to:u,calcMode:"spline",keySplines:W.replaceAll(",",""),keyTimes:"0; 1",fill:"freeze"}});f.beginElement(),setTimeout(()=>{o.setAttribute("d",u),f.remove()},z)})}resetTranslation(){const e=this.container.getBoundingClientRect().height,n=document.querySelector(".board").getBoundingClientRect().height;this.x=30,this.y=e/2-n/this.k/2,this.k=1,requestAnimationFrame(()=>{this.boardContainer.style.transform=`translate(${this.x}px, ${this.y}px) scale(${this.k})`})}gameOver(e){this.boards.forEach(n=>{n[2].forEach(s=>{s.onmousemove=null,s.onpointerenter=null,s.onpointerleave=null,s.onclick=null})}),Y.textContent="Game over: ",H.textContent=e===p.Empty?"Tie":`${e} won`}getBoardOrDefault(e){if(!this.boards.has(e)){const n=C("div",{classes:["board"]});this.boardContainer.insertBefore(n,this.boardContainer.firstChild);const s=C("div",{parent:n,classes:["board-text"]}),r=C("div",{parent:n,classes:["cell-container"]}),o=Array.from({length:9},()=>C("div",{parent:r}));this.boards.set(e,[n,s,o])}return this.boards.get(e)}getLinkOrDefault(e,n){const s=`${e}-${n}`;if(!this.links.has(s)){const r=S("path",{parent:this.linkContainer});this.links.set(s,r)}return this.links.get(s)}forEachDescendant(e,n){const s=[e];for(const r of s)s.push(...r.children),n(r)}}const X=document.getElementById("popup"),T=document.getElementById("popupText");document.getElementById("viewBoard").onclick=()=>{X.style.display="none"};document.getElementById("playAgain").onclick=async()=>{X.style.display="none",await M()};async function M(){const t=document.getElementById("main");t.firstChild!==null&&t.removeChild(t.firstChild);const e=new bt(Ot,()=>({board:[p.Empty,p.Empty,p.Empty,p.Empty,p.Empty,p.Empty,p.Empty,p.Empty,p.Empty],moveIndex:0,moveCharacter:p.Empty})),n=new _t(t,e,s=>{function r(h,i){return h.filter(l=>l[0]===i&&l[1]===i&&l[2]===i||l[3]===i&&l[4]===i&&l[5]===i||l[6]===i&&l[7]===i&&l[8]===i||l[0]===i&&l[3]===i&&l[6]===i||l[1]===i&&l[4]===i&&l[7]===i||l[2]===i&&l[5]===i&&l[8]===i||l[0]===i&&l[4]===i&&l[8]===i||l[2]===i&&l[4]===i&&l[6]===i).length}const o=[...e.getCache().values()].filter(h=>h.moveCharacter!==p.Empty).map(h=>h.board),a=r(o,p.X),c=r(o,p.O);(a>0||c>0)&&(a>0&&c===0?(T.textContent=`Congratulations! X won on ${a} boards!`,n.gameOver(p.X)):c>0&&a===0?(T.textContent=`Congratulations! O won on ${c} boards!`,n.gameOver(p.O)):a>0&&c>0&&(T.textContent=`Tie! X won on ${a} boards and O won on ${c} boards!`,n.gameOver(p.Empty)),X.style.display="block")});queueMicrotask(()=>{n.setSize(t.clientWidth,t.clientHeight)}),window.onresize=()=>{n.setSize(t.clientWidth,t.clientHeight)}}(async()=>(document.getElementById("restart").onclick=async()=>{await M()},await M()))();
